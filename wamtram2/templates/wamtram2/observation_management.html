{% extends "base_wastd.html" %}
{% load static bootstrap4 %}

{% block extra_style %}
    {{ block.super }}
    {{ form.media.css }}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme/dist/select2-bootstrap4.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/grid.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/loading_spinner.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/loading_overlay.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/observation_management.css' %}">
{% endblock %}

{% block breadcrumbs %}
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="d-none d-md-block">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'wamtram2:admin_tools' %}">Curation Tools</a></li>
            <li class="breadcrumb-item active">Manage Observation</li>
        </ol>
    </nav>
{% endblock %}

{% block page_content_inner %}
<div class="container-fluid mt-3">
    <!-- Top Filter and Search Area -->
    <div class="row mb-3">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Observation Management</h2>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" id="saveChanges">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Area -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="input-group">
                <input type="text" class="form-control" id="tagSearch" placeholder="Search by Tag ID...">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results Table -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="searchResults">
                            <thead>
                                <tr>
                                    <th>Observation ID</th>
                                    <th>Turtle ID</th>
                                    <th>Observation Date/Time</th>
                                    <th>Place</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Results will be dynamically populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- No Results Message -->
    <div id="noResults" class="row mb-3" style="display: none;">
        <div class="col-md-12">
            <div class="alert alert-info">
                No results found
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <div class="col-md-12">
            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#basicInfo">Basic Information</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#tagInfo">Tag Information</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#measurements">Measurements</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#damage">Damage Records</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#location">Location</a>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Basic Information Tab -->
                <div id="basicInfo" class="tab-pane active">
                    <div class="section-card">
                        <div class="form-row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Observation ID</label>
                                    <input type="text" class="form-control readonly-field" name="observation_id" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Turtle ID</label>
                                    <input type="text" class="form-control readonly-field" name="turtle_id" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" class="form-control" name="observation_date" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Time</label>
                                    <input type="time" class="form-control" name="observation_time">
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Alive</label>
                                    <select class="form-control" name="alive" required>
                                        <option value="Y">Yes</option>
                                        <option value="N">No</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Nesting</label>
                                    <select class="form-control" name="nesting">
                                        <option value="Y">Yes</option>
                                        <option value="N">No</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Activity</label>
                                    <select class="form-control" name="activity_code">
                                        {% for activity in activities %}
                                            <option value="{{ activity.activity_code }}">{{ activity.description }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Beach Position</label>
                                    <select class="form-control" name="beach_position_code">
                                        {% for position in beach_positions %}
                                            <option value="{{ position.position_code }}">{{ position.description }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tag Information Tab -->
                <div id="tagInfo" class="tab-pane fade">
                    <div class="section-card">
                        <h4>Flipper Tags</h4>
                        <!-- Tag Container -->
                        <div class="tag-container">
                            <!-- Template for tag row (hidden) -->
                            <div class="tag-row-template" style="display: none;" id="tagRowTemplate">
                                <div class="tag-row form-row mb-2">
                                    <div class="col">
                                        <input type="text" class="form-control" name="tag_id" placeholder="Tag ID">
                                    </div>
                                    <div class="col">
                                        <select class="form-control" name="side">
                                            <option value="">Select Side...</option>
                                            <option value="L">Left</option>
                                            <option value="R">Right</option>
                                        </select>
                                    </div>
                                    <div class="col">
                                        <select class="form-control" name="tag_position">
                                            <option value="">Select Position...</option>
                                            <option value="1">Position 1</option>
                                            <option value="2">Position 2</option>
                                            <option value="3">Position 3</option>
                                        </select>
                                    </div>
                                    <div class="col">
                                        <select class="form-control" name="tag_state">
                                            <option value="">Select State...</option>
                                            {% for state in tag_states %}
                                                <option value="{{ state.state_code }}">{{ state.description }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-auto">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" name="barnacles">
                                            <label class="form-check-label">Barnacles</label>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <button type="button" class="btn btn-danger btn-sm remove-tag">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Active tag rows will be added here -->
                        </div>

                        <button type="button" class="btn btn-outline-secondary mt-3" id="addTag">
                            <i class="fas fa-plus"></i> Add Tag
                        </button>

                        <h4 class="mt-4">PIT Tags</h4>
                        <!-- PIT Tag Container -->
                        <div class="pit-tag-container">
                            <!-- Template for PIT tag row (hidden) -->
                            <div class="pit-tag-row-template" style="display: none;">
                                <div class="pit-tag-row form-row mb-2">
                                    <div class="col">
                                        <input type="text" class="form-control" name="pittag_id" placeholder="PIT Tag ID">
                                    </div>
                                    <div class="col">
                                        <select class="form-control" name="pit_tag_position">
                                            <option value="">Select Position...</option>
                                            <option value="LFF">Left Front Flipper</option>
                                            <option value="RFF">Right Front Flipper</option>
                                        </select>
                                    </div>
                                    <div class="col">
                                        <select class="form-control" name="tag_state">
                                            <option value="">Select State...</option>
                                            {% for state in tag_states %}
                                                <option value="{{ state.state_code }}">{{ state.description }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-auto">
                                        <button type="button" class="btn btn-danger btn-sm remove-tag">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Active PIT tag rows will be added here -->
                        </div>

                        <button type="button" class="btn btn-outline-secondary mt-3" id="addPitTag">
                            <i class="fas fa-plus"></i> Add PIT Tag
                        </button>
                    </div>
                </div>

                <!-- Measurements Tab -->
                <div id="measurements" class="tab-pane fade">
                    <div class="section-card">
                        <!-- Template for measurement row (hidden) -->
                        <div class="measurement-row-template" style="display: none;" id="measurementRowTemplate">
                            <div class="measurement-row form-row mb-2">
                                <div class="col">
                                    <select class="form-control" name="measurement_type">
                                        <option value="">Select Type...</option>
                                        {% for type in measurement_types %}
                                            <option value="{{ type.code }}">{{ type.description }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col">
                                    <input type="number" class="form-control" name="measurement_value" step="0.1">
                                </div>
                                <div class="col-auto">
                                    <button type="button" class="btn btn-danger btn-sm remove-measurement">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="measurement-container">
                            <!-- Active measurement rows will be added here -->
                        </div>
                        <button type="button" class="btn btn-outline-secondary mt-3" id="addMeasurement">
                            <i class="fas fa-plus"></i> Add Measurement
                        </button>
                    </div>
                </div>

                <!-- Damage Records Tab -->
                <div id="damage" class="tab-pane fade">
                    <div class="section-card">
                        <!-- Template for damage record row (hidden) -->
                        <div class="damage-row-template" style="display: none;" id="damageRowTemplate">
                            <div class="damage-record form-row mb-2">
                                <div class="col">
                                    <select class="form-control" name="body_part">
                                        <option value="">Select Body Part...</option>
                                        {% for part in body_parts %}
                                            <option value="{{ part.body_part }}">{{ part.description }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col">
                                    <select class="form-control" name="damage_code">
                                        <option value="">Select Damage...</option>
                                        {% for code in damage_codes %}
                                            <option value="{{ code.damage_code }}">{{ code.description }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button type="button" class="btn btn-danger btn-sm remove-damage">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="damage-container">
                            <!-- Active damage records will be added here -->
                        </div>
                        <button type="button" class="btn btn-outline-secondary mt-3" id="addDamage">
                            <i class="fas fa-plus"></i> Add Damage Record
                        </button>
                    </div>
                </div>

                <!-- Location Tab -->
                <div id="location" class="tab-pane fade">
                    <div class="section-card">
                        <div class="form-row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Place</label>
                                    <select class="form-control" name="place_code" required>
                                        {% for place in places %}
                                            <option value="{{ place.place_code }}">{{ place.description }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Datum</label>
                                    <select class="form-control" name="datum_code">
                                        <option value="WGS84">WGS84</option>
                                        <option value="GDA94">GDA94</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col-md-6">
                                <h5>Latitude</h5>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="latitude_degrees" placeholder="Degrees">
                                    <input type="number" step="0.001" class="form-control" name="latitude_minutes" placeholder="Minutes">
                                    <input type="number" step="0.001" class="form-control" name="latitude_seconds" placeholder="Seconds">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Longitude</h5>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="longitude_degrees" placeholder="Degrees">
                                    <input type="number" step="0.001" class="form-control" name="longitude_minutes" placeholder="Minutes">
                                    <input type="number" step="0.001" class="form-control" name="longitude_seconds" placeholder="Seconds">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading spinner -->
<div class="loading-spinner">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>

<!-- Loading overlay -->
<div class="loading-overlay"></div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="{% static 'js/observation_management.js' %}"></script>
{% endblock %} 