{% extends "base_wastd.html" %}
{% load static bootstrap4 dict_filter %}
{% load group_filters %}
{% load perth_time_filters %}

{% block extra_style %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'css/search_styles.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/loading_spinner.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/disabled_btn.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/loading_overlay.css' %}">
    <style>
        .sort-icon { cursor: pointer; margin-left: 5px; color: #999; }
        .sort-icon.active { color: #333; }
        .sort-icon.asc:after { content: "↑"; }
        .sort-icon.desc:after { content: "↓"; }
        .sort-icon.none:after { content: "↕"; }
    </style>
{% endblock %}

{% block page_content_inner %}
    <h1 class="page-title">Batch Entry Management</h1>
    <div class="alert alert-info">
        Current Filter:
        {% if filter_params.location %} Location: {{ filter_params.location }} {% endif %}
        {% if filter_params.place %} Place: {{ filter_params.place }} {% endif %}
        {% if filter_params.year %} Year: {{ filter_params.year }} {% endif %}
    </div>
    <form method="get" class="form-inline mb-3">
        <input type="text" name="search" class="form-control mr-2" placeholder="Search Entry ID or System Message" value="{{ request.GET.search }}">
        <button type="submit" class="btn btn-primary">Search</button>
    </form>
    {% if object_list %}
    <div class="row mt-3">
        <div class="col">
            <table class="table table-striped table-bordered table-sm table-hover">
                <thead>
                    <tr>
                        <th>Batch ID</th>
                        <th>Entry ID <span class="sort-icon none" data-field="data_entry_id"></span></th>
                        <th>Saved Observation <span class="sort-icon none" data-field="observation_id"></span></th>
                        <th>Observation date <span class="sort-icon none" data-field="observation_date"></span></th>
                        <th>Turtle ID</th>
                        <th>Recapture Tags</th>
                        <th>New Tags</th>
                        <th>Lay?</th>
                        <th>System Message</th>
                        <th>Enterer</th>
                        <th>Needs Review</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody>
                    {% for obj in object_list %}
                    <tr>
                        <td>
                            <a href="{% url 'wamtram2:entry_batch_detail' batch_id=obj.entry_batch.entry_batch_id %}">{{ obj.entry_batch.entry_batch_id }}</a>
                        </td>
                        <td><a href="{% url 'wamtram2:trtdataentry' obj.data_entry_id %}">{{ obj.data_entry_id }}</a></td>
                        <td>{% if obj.observation_id %}<a href="{% url 'wamtram2:observationdetail' pk=obj.observation_id.pk %}">{{ obj.observation_id.pk }}</a>{% endif %}</td>
                        <td>{{ obj.observation_date|perth_time|date:"j M Y H:i" }}</td>
                        <td>{% if obj.turtle_id %}<a href="{% url 'wamtram2:turtle_detail' obj.turtle_id %}">{{obj.turtle_id}}</a>{% endif %}</td>
                        <td>
                            {% if obj.recapture_left_tag_id %}{{ obj.recapture_left_tag_id }} {% endif %}
                            {% if obj.recapture_left_tag_id_2 %}{{ obj.recapture_left_tag_id_2 }} {% endif %}
                            {% if obj.recapture_left_tag_id_3 %}{{ obj.recapture_left_tag_id_3 }} {% endif %}
                            {% if obj.recapture_right_tag_id %}{{ obj.recapture_right_tag_id }} {% endif %}
                            {% if obj.recapture_right_tag_id_2 %}{{ obj.recapture_right_tag_id_2 }} {% endif %}
                            {% if obj.recapture_right_tag_id_3 %}{{ obj.recapture_right_tag_id_3 }} {% endif %}
                            {% if obj.recapture_pittag_id %}{{ obj.recapture_pittag_id }} {% endif %}
                            {% if obj.recapture_pittag_id_2 %}{{ obj.recapture_pittag_id_2 }} {% endif %}
                        </td>
                        <td>
                            {% if obj.new_left_tag_id %}{{ obj.new_left_tag_id }} {% endif %}
                            {% if obj.new_left_tag_id_2 %}{{ obj.new_left_tag_id_2 }} {% endif %}
                            {% if obj.new_right_tag_id %}{{ obj.new_right_tag_id }} {% endif %}
                            {% if obj.new_right_tag_id_2 %}{{ obj.new_right_tag_id_2 }} {% endif %}
                            {% if obj.new_pittag_id %}{{ obj.new_pittag_id }} {% endif %}
                            {% if obj.new_pittag_id_2 %}{{ obj.new_pittag_id_2 }} {% endif %}
                        </td>
                        <td>{{ obj.clutch_completed }}</td>
                        <td>{{ obj.error_message }}</td>
                        <td>
                            {% if obj.entered_by_id %}
                                {% with persons|get:obj.entered_by_id as person %}
                                    {% if person %}
                                        {{ person.first_name }} {{ person.surname }}
                                    {% else %}
                                        {{ obj.entered_by }}
                                    {% endif %}
                                {% endwith %}
                            {% elif obj.entered_by %}
                                {{ obj.entered_by }}
                            {% else %}
                                <p>No Enterer Assigned</p>
                            {% endif %}
                        </td>
                        <td>{% if obj.do_not_process %}Yes{% else %}No{% endif %}</td>
                        <td>{{ obj.comments }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
        <div class="row mt-3">
            <div class="col">
                <p>No data entries found.</p>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    // 可复用排序 JS 逻辑
    $(document).ready(function() {
        $('.sort-icon').click(function() {
            const field = $(this).data('field');
            const currentState = $(this).attr('class').includes('none') ? 'none' : 
                $(this).attr('class').includes('asc') ? 'asc' : 'desc';
            $('.sort-icon').removeClass('active asc desc').addClass('none');
            let newState;
            if (currentState === 'none') {
                newState = 'asc';
            } else if (currentState === 'asc') {
                newState = 'desc';
            } else {
                newState = 'none';
            }
            if (newState !== 'none') {
                $(this).removeClass('none').addClass(`active ${newState}`);
            }
            const tbody = $('table tbody');
            const rows = tbody.find('tr').get();
            if (newState === 'none') {
                rows.sort((a, b) => {
                    return $(a).find('td:nth-child(2)').text().localeCompare($(b).find('td:nth-child(2)').text());
                });
            } else {
                rows.sort((a, b) => {
                    let aValue = $(a).find(`td:nth-child(${$(this).closest('th').index() + 1})`).text().trim();
                    let bValue = $(b).find(`td:nth-child(${$(this).closest('th').index() + 1})`).text().trim();
                    if (!isNaN(aValue) && !isNaN(bValue)) {
                        aValue = parseFloat(aValue) || 0;
                        bValue = parseFloat(bValue) || 0;
                    }
                    if (field === 'observation_date') {
                        aValue = new Date(aValue || 0);
                        bValue = new Date(bValue || 0);
                    }
                    if (newState === 'asc') {
                        return aValue > bValue ? 1 : -1;
                    } else {
                        return aValue < bValue ? 1 : -1;
                    }
                });
            }
            tbody.empty();
            rows.forEach(row => tbody.append(row));
        });
    });
</script>
{% endblock %} 